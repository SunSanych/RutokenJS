<html>
<head>
<title>Test</title>
</head>
<body>
<script type="text/javascript" src="const.js"></script>
<script type="text/javascript">

var rutoken = require('./rutoken/build/Release/rutoken');
var gui     = require('nw.gui');
var fs      = require('fs');
var Crypto  = require('crypto');

//Crypto.setEngine('ENGINE_METHOD_ALL');
console.log('Ciphers: ', Crypto.getCiphers());
console.log('Hashes: ', Crypto.getHashes());
console.log('Path: ', gui.App.dataPath);

console.log('initialize() ',  CKR[rutoken.initialize()]);

var isInitialize = rutoken.isInitialize();
console.log('isInitialize() ', isInitialize);

if(isInitialize) {

	rutoken.getLibInfo(function(res) {
		console.log('getLibInfo: \n', res);
	})

	var cntSlot = rutoken.countSlot();
	console.log('cntSlot: ', cntSlot);

	if(cntSlot > 0) {

		// !!! initToken
		// Для форматирования токена используется стандартный PIN администратора или PUK для Рутокен Web == 87654321
		console.log('initToken: ', CKR[rutoken.initToken(1)]);
		// !!! initToken

		for(var i=0; i <= cntSlot-1; i++) {
			rutoken.getSlotInfo(i, function(res) {
				console.log('Slot info #' + i + "\n", res);
			});
			rutoken.getTokenInfo(i, function(res) {
				console.log('Token info #' + i + "\n", res);
			});
			rutoken.getMechanismList(i, function(res) {
				console.log('Mechanism list #' + i + "\n");
				if(res.count > 0) {
					res.list.forEach(function(item) {
						item.typeText = CKM[item.type];
						console.log(item);
					});
				}
			});
		}

		if((rv = rutoken.login(0, '12345678')) == CKR_OK) {
			rutoken.random(64, function(res){
				console.log('Random: ', res);
			});
			rutoken.getObjectList(function(res){
				console.log('getObjectList: ', res);
			});
		} else {
			console.log('Login error: ' + CKR[rv]);
		}

	}

	console.log('finalize() ', CKR[rutoken.finalize()]);
}

console.log('End');
</script>
</body>
</html>
